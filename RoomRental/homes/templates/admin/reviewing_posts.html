{% extends "admin/base_site.html" %}

{% block branding %}
<h1 id="site-name">Reviewing posts</h1>
{% endblock %}

{% block content %}
{% comment %} import lib {% endcomment %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{% comment %} end import lib {% endcomment %}

<div class="container mt-4">
    <div class="table-responsive">
        <table id="posts-table" class="table table-bordered table-hover">
            <thead class="table-light">
                <tr>
                    <th scope="col">Id</th>
                    <th scope="col">Title</th>  
                    <th scope="col">City</th>
                    <th scope="col">District</th>
                    <th scope="col">Address</th>
                    <th scope="col">Latitude</th>
                    <th scope="col">Longitude</th>
                    <th scope="col">Acreage</th>
                    <th scope="col">Price</th>
                    <th scope="col">Room Type</th>
                    <th scope="col">Max People</th>
                    <th scope="col">Current People</th>
                    <th scope="col">Phone Number</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be inserted here by JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center" id="pagination-controls">
        <li style="list-style-type: none;" class="page-item" id="previous-page">
            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
        </li>
        <!-- Page numbers will be inserted here by JavaScript -->
        <li class="page-item" id="next-page">
            <a class="page-link" href="#">Next</a>
        </li>
    </ul>
</nav>

<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h2>Post Details</h2>
        </div>
        <div class="card-body">
            <h3 class="card-title" id="post-title">Title</h3>
            <h5 class="card-subtitle mb-2 text-muted" id="post-owner">Owner: </h5>
            <p class="card-text" id="post-description">Description: </p>
            <div class="row">
                <div class="col-md-6">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>City:</strong> <span id="post-city"></span></li>
                        <li class="list-group-item"><strong>District:</strong> <span id="post-district"></span></li>
                        <li class="list-group-item"><strong>Address:</strong> <span id="post-address"></span></li>
                        <li class="list-group-item"><strong>Latitude:</strong> <span id="post-latitude"></span></li>
                        <li class="list-group-item"><strong>Longitude:</strong> <span id="post-longitude"></span></li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>Acreage:</strong> <span id="post-acreage"></span></li>
                        <li class="list-group-item"><strong>Price:</strong> <span id="post-price"></span></li>
                        <li class="list-group-item"><strong>Room Type:</strong> <span id="post-room-type"></span></li>
                        <li class="list-group-item"><strong>Max People:</strong> <span id="post-max-people"></span></li>
                        <li class="list-group-item"><strong>Current People:</strong> <span id="post-current-people"></span></li>
                        <li class="list-group-item"><strong>Phone Number:</strong> <span id="post-phone-number"></span></li>
                        <li class="list-group-item"><strong>Pending Status:</strong> <span id="post-pending-status"></span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async function() {
    const tableBody = document.querySelector("#posts-table tbody");
    const paginationControls = document.querySelector("#pagination-controls");
    const previousPage = document.querySelector("#previous-page");
    const nextPage = document.querySelector("#next-page");
    let currentPage = 1;
    let totalPages = 1;

    async function fetchPosts(page = 1) {
        const url = `http://127.0.0.1:8000/post_accommodations?pending_status=PD&page_size=1&page=${page}`;
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching data:', error);
            return { results: [], count: 0 };
        }
    }

    function populateTable(posts) {
        tableBody.innerHTML = "";
        if (posts.length === 0) {
            const row = document.createElement("tr");
            const cell = document.createElement("td");
            cell.colSpan = 12;
            cell.textContent = "No posts available.";
            cell.className = "text-center";
            row.appendChild(cell);
            tableBody.appendChild(row);
            return;
        }
        posts.forEach(post => {
            const row = document.createElement("tr");

            row.innerHTML = `
                <td>${post.id}</td>
                <td>${post.title}</td>
                <td>${post.city}</td>
                <td>${post.district}</td>
                <td>${post.address}</td>
                <td>${post.latitude ?? ''}</td>
                <td>${post.longitude ?? ''}</td>
                <td>${post.acreage ?? ''}</td>
                <td>${post.price ?? ''}</td>
                <td>${post.room_type}</td>
                <td>${post.max_people}</td>
                <td>${post.current_people}</td>
                <td>${post.phone_number}</td>
            `;

            tableBody.appendChild(row);
        });
    }

    function updatePaginationControls() {
        paginationControls.querySelectorAll(".page-number").forEach(pageNumber => pageNumber.remove());
        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement("li");
            li.className = `page-item page-number ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            li.addEventListener("click", (e) => {
                e.preventDefault();
                if (i !== currentPage) {
                    currentPage = i;
                    loadPosts();
                }
            });
            nextPage.before(li);
        }
    }

    async function loadPosts() {
        const data = await fetchPosts(currentPage);
        populateTable(data.results);
        totalPages = Math.ceil(data.count / 1); // Assuming page size of 1 for example purposes

        previousPage.classList.toggle("disabled", currentPage === 1);
        nextPage.classList.toggle("disabled", currentPage === totalPages);

        updatePaginationControls();
    }

    previousPage.addEventListener("click", (e) => {
        e.preventDefault();
        if (currentPage > 1) {
            currentPage--;
            loadPosts();
        }
    });

    nextPage.addEventListener("click", (e) => {
        e.preventDefault();
        if (currentPage < totalPages) {
            currentPage++;
            loadPosts();
        }
    });

    // Load initial posts
    loadPosts();
});
</script>

{% endblock %}
